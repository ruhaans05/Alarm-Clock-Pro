<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarm Clock Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .day-checkbox:checked + label {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl mx-auto bg-gray-800 rounded-2xl shadow-lg p-6 space-y-6">
        
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-3xl font-bold text-white">Alarm Clock Pro</h1>
            <p id="currentTime" class="text-lg text-gray-400 mt-1">Loading...</p>
        </header>

        <!-- Do Not Disturb Section -->
        <section id="dnd-section" class="bg-gray-700/50 p-4 rounded-lg">
            <h2 class="text-xl font-semibold mb-3 text-white">Do Not Disturb</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="dndStart" class="block text-sm font-medium text-gray-300 mb-1">Start Time</label>
                    <input type="datetime-local" id="dndStart" class="w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="dndEnd" class="block text-sm font-medium text-gray-300 mb-1">End Time</label>
                    <input type="datetime-local" id="dndEnd" class="w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            <div class="flex justify-end mt-3 gap-2">
                 <button id="clearDnd" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-medium rounded-md text-sm transition-colors">Clear</button>
                <button id="setDnd" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md text-sm transition-colors">Set Period</button>
            </div>
            <p id="dndStatus" class="text-center text-sm mt-2 text-yellow-400"></p>
        </section>

        <!-- Alarms List -->
        <section id="alarms-list-section">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white">Your Alarms</h2>
                <button id="addAlarmBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                    + Add Alarm
                </button>
            </div>
            <div id="alarmsContainer" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                <!-- Alarm items will be injected here -->
            </div>
        </section>

    </div>

    <!-- Alarm Modal -->
    <div id="alarmModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-md space-y-5 transform transition-all scale-95 opacity-0" id="modalContent">
            <h2 class="text-2xl font-bold text-center text-white" id="modalTitle">Set Alarm</h2>
            
            <input type="hidden" id="alarmId">

            <div>
                <label for="alarmName" class="block text-sm font-medium text-gray-300 mb-1">Alarm Name</label>
                <input type="text" id="alarmName" placeholder="e.g., Morning Wake Up" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div>
                <label for="alarmTime" class="block text-sm font-medium text-gray-300 mb-1">Alarm Time</label>
                <input type="time" id="alarmTime" required class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <!-- Ringtone -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Ringtone</label>
                <div class="flex items-center gap-4">
                     <button id="playDefaultTone" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 text-white font-medium rounded-md text-sm transition-colors">Preview Default</button>
                     <label for="ringtoneFile" class="cursor-pointer px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md text-sm transition-colors">Upload MP3</label>
                     <input type="file" id="ringtoneFile" accept=".mp3" class="hidden">
                </div>
                 <p id="ringtoneFileName" class="text-xs text-gray-400 mt-2">Using default tone.</p>
            </div>

            <!-- Recurring Days -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Recur on</label>
                <div class="grid grid-cols-4 md:grid-cols-7 gap-2">
                    <!-- Day checkboxes -->
                    <div class="text-center" data-day="1"><input id="day-mon" type="checkbox" class="hidden day-checkbox"><label for="day-mon" class="cursor-pointer block border border-gray-600 rounded-full px-3 py-1.5 text-sm hover:bg-gray-700 transition-colors">Mon</label></div>
                    <div class="text-center" data-day="2"><input id="day-tue" type="checkbox" class="hidden day-checkbox"><label for="day-tue" class="cursor-pointer block border border-gray-600 rounded-full px-3 py-1.5 text-sm hover:bg-gray-700 transition-colors">Tue</label></div>
                    <div class="text-center" data-day="3"><input id="day-wed" type="checkbox" class="hidden day-checkbox"><label for="day-wed" class="cursor-pointer block border border-gray-600 rounded-full px-3 py-1.5 text-sm hover:bg-gray-700 transition-colors">Wed</label></div>
                    <div class="text-center" data-day="4"><input id="day-thu" type="checkbox" class="hidden day-checkbox"><label for="day-thu" class="cursor-pointer block border border-gray-600 rounded-full px-3 py-1.5 text-sm hover:bg-gray-700 transition-colors">Thu</label></div>
                    <div class="text-center" data-day="5"><input id="day-fri" type="checkbox" class="hidden day-checkbox"><label for="day-fri" class="cursor-pointer block border border-gray-600 rounded-full px-3 py-1.5 text-sm hover:bg-gray-700 transition-colors">Fri</label></div>
                    <div class="text-center" data-day="6"><input id="day-sat" type="checkbox" class="hidden day-checkbox"><label for="day-sat" class="cursor-pointer block border border-gray-600 rounded-full px-3 py-1.5 text-sm hover:bg-gray-700 transition-colors">Sat</label></div>
                    <div class="text-center" data-day="0"><input id="day-sun" type="checkbox" class="hidden day-checkbox"><label for="day-sun" class="cursor-pointer block border border-gray-600 rounded-full px-3 py-1.5 text-sm hover:bg-gray-700 transition-colors">Sun</label></div>
                </div>
            </div>

            <!-- Recurrence Period -->
            <div class="space-y-4">
                <div>
                    <label for="runUntil" class="block text-sm font-medium text-gray-300 mb-1">Run Until (Optional)</label>
                    <input type="date" id="runUntil" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            
            <!-- Modal Actions -->
            <div class="flex justify-end gap-4 pt-4">
                <button id="cancelAlarm" class="px-5 py-2 bg-gray-600 hover:bg-gray-500 text-white font-medium rounded-md transition-colors">Cancel</button>
                <button id="saveAlarm" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md transition-colors">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Active Alarm Overlay -->
    <div id="alarmActiveOverlay" class="fixed inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden z-50 text-center">
        <div class="animate-pulse text-6xl mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" fill="currentColor" class="bi bi-bell-fill text-yellow-300 inline-block" viewBox="0 0 16 16">
                <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zm.995-14.901a1 1 0 1 0-1.99 0A5.002 5.002 0 0 0 3 6c0 1.098-.5 6-2.768 7.368A1 1 0 0 0 1 14h14a1 1 0 0 0 .768-.368C13.5 12 13 7.098 13 6a5.002 5.002 0 0 0-4.005-4.901z"/>
            </svg>
        </div>
        <h2 class="text-4xl font-bold text-white mb-2">Wake Up!</h2>
        <p id="activeAlarmTime" class="text-2xl text-gray-300 mb-8"></p>
        <button id="snoozeAlarm" class="px-8 py-4 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg text-lg mr-4 transition-colors">Snooze (10 min)</button>
        <button id="stopAlarm" class="px-8 py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-lg transition-colors">Stop Alarm</button>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // STATE MANAGEMENT
    let alarms = JSON.parse(localStorage.getItem('alarms')) || [];
    let dndPeriod = JSON.parse(localStorage.getItem('dndPeriod')) || { start: null, end: null };
    let customRingtone = null; // This will hold the ArrayBuffer for the custom tone
    let activeAlarmId = null;
    let audioContext;
    let defaultToneBuffer;
    let alarmSoundSource;

    // UI ELEMENTS
    const currentTimeEl = document.getElementById('currentTime');
    const alarmsContainer = document.getElementById('alarmsContainer');
    const addAlarmBtn = document.getElementById('addAlarmBtn');
    const alarmModal = document.getElementById('alarmModal');
    const modalContent = document.getElementById('modalContent');
    const modalTitle = document.getElementById('modalTitle');
    const saveAlarmBtn = document.getElementById('saveAlarm');
    const cancelAlarmBtn = document.getElementById('cancelAlarm');
    const alarmIdInput = document.getElementById('alarmId');
    const alarmNameInput = document.getElementById('alarmName');
    const alarmTimeInput = document.getElementById('alarmTime');
    const ringtoneFileInput = document.getElementById('ringtoneFile');
    const ringtoneFileNameEl = document.getElementById('ringtoneFileName');
    const playDefaultToneBtn = document.getElementById('playDefaultTone');
    const runUntilInput = document.getElementById('runUntil');
    const alarmActiveOverlay = document.getElementById('alarmActiveOverlay');
    const activeAlarmTimeEl = document.getElementById('activeAlarmTime');
    const snoozeAlarmBtn = document.getElementById('snoozeAlarm');
    const stopAlarmBtn = document.getElementById('stopAlarm');
    const dndStartInput = document.getElementById('dndStart');
    const dndEndInput = document.getElementById('dndEnd');
    const setDndBtn = document.getElementById('setDnd');
    const clearDndBtn = document.getElementById('clearDnd');
    const dndStatusEl = document.getElementById('dndStatus');


    // --- INITIALIZATION ---
    
    // Initialize AudioContext
    const initAudio = () => {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            createDefaultTone();
        }
    };
    
    // Create a simple default beep tone
    function createDefaultTone() {
        if (!audioContext) return;
        const duration = 0.5;
        const sampleRate = audioContext.sampleRate;
        const frameCount = sampleRate * duration;
        const buffer = audioContext.createBuffer(1, frameCount, sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < frameCount; i++) {
            const time = i / sampleRate;
            // A simple sine wave at 440 Hz (A4)
            data[i] = Math.sin(2 * Math.PI * 440 * time) * Math.exp(-time * 5);
        }
        defaultToneBuffer = buffer;
    }

    // Update the clock every second
    setInterval(updateTime, 1000);
    updateTime();
    renderAlarms();
    renderDndStatus();

    // --- CORE LOGIC ---
    
    function formatTime(timeString) {
        const [hour, minute] = timeString.split(':');
        const date = new Date();
        date.setHours(hour, minute, 0, 0);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const dateString = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        currentTimeEl.textContent = `${dateString} | ${timeString}`;
        checkAlarms(now);
    }
    
    function checkAlarms(now) {
        if (activeAlarmId) return; // An alarm is already ringing

        // Check for Do Not Disturb period
        if (dndPeriod.start && dndPeriod.end) {
            const dndStart = new Date(dndPeriod.start);
            const dndEnd = new Date(dndPeriod.end);
            if (now >= dndStart && now <= dndEnd) {
                if (!dndStatusEl.textContent.includes('ACTIVE')) {
                   dndStatusEl.textContent = `DND ACTIVE until ${dndEnd.toLocaleString()}`;
                }
                return;
            } else if (dndStatusEl.textContent.includes('ACTIVE')) {
                renderDndStatus(); // Reset status if period ended
            }
        }
        
        alarms.forEach(alarm => {
            if (!alarm.isActive) return;

            const [alarmHour, alarmMinute] = alarm.time.split(':').map(Number);
            
            // Check if current time matches alarm time
            if (now.getHours() === alarmHour && now.getMinutes() === alarmMinute && now.getSeconds() === 0) {
                 const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                 
                 // Check end date
                 if (alarm.endDate) {
                    const endDate = new Date(alarm.endDate);
                    endDate.setHours(23, 59, 59, 999); // Ensure check is inclusive of the end day
                    if (today > endDate) {
                        return;
                    }
                 }
                 
                 // Check weekly recurrence
                 const dayOfWeekMatch = alarm.daysOfWeek.length === 0 || alarm.daysOfWeek.includes(now.getDay());
                 if (!dayOfWeekMatch) return;

                 // All checks passed, trigger alarm
                 triggerAlarm(alarm);
            }
        });
    }

    function triggerAlarm(alarm) {
        initAudio();
        activeAlarmId = alarm.id;
        activeAlarmTimeEl.textContent = `It's ${formatTime(alarm.time)}`;
        alarmActiveOverlay.classList.remove('hidden');
        alarmActiveOverlay.classList.add('flex');
        
        let toneBuffer = alarm.ringtoneData ? audioContext.createBuffer(alarm.ringtoneData.numberOfChannels, alarm.ringtoneData.length, alarm.ringtoneData.sampleRate) : defaultToneBuffer;
        
        if(alarm.ringtoneData){
            for(let i=0; i < alarm.ringtoneData.numberOfChannels; i++){
                toneBuffer.copyToChannel(Float32Array.from(Object.values(alarm.ringtoneData.channels[i])), i);
            }
        }
        
        const playSound = () => {
             if (alarmSoundSource) {
                alarmSoundSource.stop();
            }
            alarmSoundSource = audioContext.createBufferSource();
            alarmSoundSource.buffer = toneBuffer;
            alarmSoundSource.connect(audioContext.destination);
            alarmSoundSource.loop = true;
            alarmSoundSource.start();
        };
        playSound();
    }
    
    function stopAlarmSound() {
        if(alarmSoundSource) {
            alarmSoundSource.stop();
            alarmSoundSource = null;
        }
        alarmActiveOverlay.classList.add('hidden');
        alarmActiveOverlay.classList.remove('flex');
        activeAlarmId = null;
    }
    
    // --- UI RENDERING & MODAL ---
    
    function renderAlarms() {
        alarmsContainer.innerHTML = '';
        if (alarms.length === 0) {
            alarmsContainer.innerHTML = `<p class="text-center text-gray-500">No alarms set. Add one to get started!</p>`;
            return;
        }
        
        alarms.forEach(alarm => {
            const alarmEl = document.createElement('div');
            alarmEl.className = 'flex items-center justify-between bg-gray-700/70 p-4 rounded-lg';
            alarmEl.dataset.id = alarm.id;

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const recurringDays = alarm.daysOfWeek.map(d => days[d]).join(', ');
            
            let recurringText = alarm.name ? `${alarm.name} | ` : '';
            recurringText += recurringDays ? recurringDays : 'Once';
            
            let recurrenceRule = '';
            if (alarm.endDate) {
                recurrenceRule += ` until ${new Date(alarm.endDate).toLocaleDateString()}`;
            }

            alarmEl.innerHTML = `
                <div>
                    <p class="text-2xl font-semibold text-white">${formatTime(alarm.time)}</p>
                    <p class="text-sm text-gray-400">${recurringText}${recurrenceRule}</p>
                </div>
                <div class="flex items-center gap-4">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer toggle-alarm" ${alarm.isActive ? 'checked' : ''}>
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    </label>
                    <button class="edit-alarm p-2 text-gray-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>
                    </button>
                    <button class="delete-alarm p-2 text-gray-400 hover:text-red-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/></svg>
                    </button>
                </div>
            `;
            alarmsContainer.appendChild(alarmEl);
        });
    }

    function openModal(alarm = null) {
        initAudio();
        modalContent.classList.remove('scale-95', 'opacity-0');
        alarmModal.classList.remove('hidden');

        if (alarm) {
            modalTitle.textContent = 'Edit Alarm';
            alarmIdInput.value = alarm.id;
            alarmNameInput.value = alarm.name || '';
            alarmTimeInput.value = alarm.time;
            document.querySelectorAll('.day-checkbox').forEach(cb => {
                const day = parseInt(cb.closest('[data-day]').dataset.day);
                cb.checked = alarm.daysOfWeek.includes(day);
            });
            runUntilInput.value = alarm.endDate || '';
            ringtoneFileNameEl.textContent = alarm.ringtoneName || 'Using default tone.';
            customRingtone = alarm.ringtoneData || null;
        } else {
            modalTitle.textContent = 'Add New Alarm';
            alarmIdInput.value = '';
            alarmNameInput.value = '';
            alarmTimeInput.value = new Date().toTimeString().substring(0, 5);
            document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
            runUntilInput.value = '';
            ringtoneFileNameEl.textContent = 'Using default tone.';
            customRingtone = null;
        }
    }

    function closeModal() {
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => alarmModal.classList.add('hidden'), 150);
        ringtoneFileInput.value = ''; // Reset file input
    }
    
    function renderDndStatus() {
        if (dndPeriod.start && dndPeriod.end) {
            const start = new Date(dndPeriod.start).toLocaleString();
            const end = new Date(dndPeriod.end).toLocaleString();
            dndStatusEl.textContent = `Alarms off from ${start} to ${end}.`;
            dndStartInput.value = dndPeriod.start.substring(0, 16);
            dndEndInput.value = dndPeriod.end.substring(0, 16);
        } else {
            dndStatusEl.textContent = '';
            dndStartInput.value = '';
            dndEndInput.value = '';
        }
    }

    // --- EVENT HANDLERS ---
    
    addAlarmBtn.addEventListener('click', () => openModal());
    cancelAlarmBtn.addEventListener('click', closeModal);
    alarmModal.addEventListener('click', (e) => {
        if (e.target === alarmModal) closeModal();
    });

    saveAlarmBtn.addEventListener('click', () => {
        const id = alarmIdInput.value || `alarm_${Date.now()}`;
        const time = alarmTimeInput.value;
        const name = alarmNameInput.value;
        if (!time) {
            alert('Please select a time for the alarm.');
            return;
        }
        
        const daysOfWeek = Array.from(document.querySelectorAll('.day-checkbox:checked'))
            .map(cb => parseInt(cb.closest('[data-day]').dataset.day));
            
        const newAlarm = {
            id,
            name,
            time,
            daysOfWeek,
            isActive: true,
            createdAt: alarmIdInput.value ? alarms.find(a => a.id === id).createdAt : new Date().toISOString(),
            endDate: runUntilInput.value || null,
            ringtoneName: ringtoneFileInput.files[0]?.name || (customRingtone ? customRingtone.name : null),
            ringtoneData: customRingtone
        };
        
        const existingIndex = alarms.findIndex(a => a.id === id);
        if (existingIndex > -1) {
            alarms[existingIndex] = newAlarm;
        } else {
            alarms.push(newAlarm);
        }
        
        saveAndRender();
        closeModal();
    });

    alarmsContainer.addEventListener('click', e => {
        const target = e.target.closest('button, .toggle-alarm');
        if (!target) return;
        
        const alarmEl = target.closest('[data-id]');
        const alarmId = alarmEl.dataset.id;
        
        if (target.classList.contains('delete-alarm')) {
            alarms = alarms.filter(a => a.id !== alarmId);
            saveAndRender();
        } else if (target.classList.contains('edit-alarm')) {
            const alarm = alarms.find(a => a.id === alarmId);
            openModal(alarm);
        } else if (target.classList.contains('toggle-alarm')) {
            const alarm = alarms.find(a => a.id === alarmId);
            alarm.isActive = target.checked;
            saveAndRender();
        }
    });
    
    // Ringtone Handlers
    ringtoneFileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !audioContext) return;
        
        ringtoneFileNameEl.textContent = `Processing ${file.name}...`;
        const arrayBuffer = await file.arrayBuffer();
        audioContext.decodeAudioData(arrayBuffer, (buffer) => {
            const duration = 10;
            const endFrame = Math.min(buffer.sampleRate * duration, buffer.length);
            const slicedBuffer = audioContext.createBuffer(buffer.numberOfChannels, endFrame, buffer.sampleRate);

            for (let i = 0; i < buffer.numberOfChannels; i++) {
                const channelData = buffer.getChannelData(i).slice(0, endFrame);
                slicedBuffer.copyToChannel(channelData, i);
            }
            
            // Storing raw data for JSON serialization
            const channels = [];
            for (let i=0; i<slicedBuffer.numberOfChannels; i++) {
                channels.push(slicedBuffer.getChannelData(i));
            }

            customRingtone = {
                name: file.name,
                length: slicedBuffer.length,
                numberOfChannels: slicedBuffer.numberOfChannels,
                sampleRate: slicedBuffer.sampleRate,
                channels: channels,
            };

            ringtoneFileNameEl.textContent = `Using: ${file.name} (first 10s)`;
        }, (error) => {
            console.error('Error decoding audio file:', error);
            ringtoneFileNameEl.textContent = 'Error: Could not process file.';
        });
    });
    
    playDefaultToneBtn.addEventListener('click', () => {
        initAudio();
        const source = audioContext.createBufferSource();
        source.buffer = defaultToneBuffer;
        source.connect(audioContext.destination);
        source.start();
    });
    
    // Alarm Active Overlay Handlers
    stopAlarmBtn.addEventListener('click', stopAlarmSound);
    
    snoozeAlarmBtn.addEventListener('click', () => {
        stopAlarmSound();
        const snoozeMinutes = 10; // Updated to 10 minutes
        const now = new Date();
        const snoozeTime = new Date(now.getTime() + snoozeMinutes * 60000);

        const snoozeAlarm = {
            id: `snooze_${Date.now()}`,
            name: 'Snoozed Alarm',
            time: snoozeTime.toTimeString().substring(0, 5),
            daysOfWeek: [], // only once
            isActive: true,
            createdAt: new Date().toISOString(),
            // Ensure no other recurrence rules apply
            endDate: null,
            ringtoneData: defaultToneBuffer // Use default for snooze
        };

        alarms.push(snoozeAlarm);
        saveAndRender();
    });

    // DND Handlers
    setDndBtn.addEventListener('click', () => {
        const start = dndStartInput.value;
        const end = dndEndInput.value;
        if (start && end && new Date(start) < new Date(end)) {
            dndPeriod = { start, end };
            localStorage.setItem('dndPeriod', JSON.stringify(dndPeriod));
            renderDndStatus();
        } else {
            alert('Please set a valid start and end time for the Do Not Disturb period.');
        }
    });

    clearDndBtn.addEventListener('click', () => {
        dndPeriod = { start: null, end: null };
        localStorage.removeItem('dndPeriod');
        renderDndStatus();
    });


    // --- UTILITY FUNCTIONS ---
    
    function saveAndRender() {
        localStorage.setItem('alarms', JSON.stringify(alarms));
        renderAlarms();
    }
});
</script>

</body>
</html>

